<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AstralAlgo App</title>
  </head>
  <body>
    <h2>App Home</h2>
    <div id="status">Checking session‚Ä¶</div>

    <script>
      function getParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      function escapeHtml(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      (async function () {
        try {
          const isMobile = getParam("mobile") === "1";
          const mobileRedirect = getParam("redirect_uri"); // astralalgomobile://auth
          const token = getParam("token"); // wix token

          // ‚úÖ Mobile mode
          if (isMobile) {
            if (mobileRedirect && token) {
              const deepLink = `${mobileRedirect}?code=${encodeURIComponent(token)}`;

              document.getElementById("status").innerHTML =
                "<b>‚úÖ Mobile login success</b><br/>" +
                "Tap the button below to return to the app.<br/><br/>" +
                `<a href="${escapeHtml(deepLink)}" style="
                  display:inline-block;
                  padding:12px 18px;
                  border-radius:10px;
                  background:#000;
                  color:#fff;
                  text-decoration:none;
                  font-weight:600;
                ">Open AstralAlgoMobile</a><br/><br/>` +
                "<small>If it doesn‚Äôt open automatically, tap the button.</small>";

              // Try auto-redirect too (may be blocked by iOS without a user gesture)
              setTimeout(() => {
                window.location.href = deepLink;
              }, 700);

              return;
            }

            document.getElementById("status").innerHTML =
              "<b>üì± Mobile mode</b><br/>" +
              "Waiting for token‚Ä¶<br/><br/>" +
              "Required URL format:<br/>" +
              "<code>?mobile=1&redirect_uri=astralalgomobile://auth&token=YOUR_WIX_TOKEN</code>";
            return;
          }

          // ‚úÖ Web behavior (unchanged)
          const res = await fetch("/.netlify/functions/me", { credentials: "include" });
          if (!res.ok) throw new Error("Not logged in (no valid session cookie).");

          const data = await res.json();
          const u = data.user;

          document.getElementById("status").innerHTML =
            "<b>‚úÖ Logged in</b><br/>" +
            "Name: " + (u.name || "-") + "<br/>" +
            "Email: " + (u.email || "-") + "<br/>" +
            "Tier: <b>" + (u.tier || "member") + "</b>";
        } catch (e) {
          document.getElementById("status").innerHTML =
            "<b>‚ùå Not logged in</b><br/>" +
            (e.message || e);
        }
      })();
    </script>
  </body>
</html>
