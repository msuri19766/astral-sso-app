<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AstralAlgo App</title>
  </head>
  <body>
    <h2>App Home</h2>
    <div id="status">Checking session‚Ä¶</div>

    <script>
      function getParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      (async function () {
        try {
          // ‚úÖ Mobile mode support (does NOT break web)
          const isMobile = getParam("mobile") === "1";
          const mobileRedirect = getParam("redirect_uri"); // e.g. astralalgomobile://auth
          const token = getParam("token"); // Wix-issued SSO token (must be provided by your flow)

          // If we're in mobile mode AND we already have the Wix token,
          // immediately deep-link back into the mobile app.
          if (isMobile && mobileRedirect && token) {
            document.getElementById("status").innerHTML =
              "<b>‚úÖ Mobile login success</b><br/>Returning to the app‚Ä¶";
            window.location.href = `${mobileRedirect}?code=${encodeURIComponent(token)}`;
            return;
          }

          // If mobile mode but token missing, show helpful debug info (web remains unaffected)
          if (isMobile) {
            document.getElementById("status").innerHTML =
              "<b>üì± Mobile mode</b><br/>" +
              "Waiting for token‚Ä¶<br/><br/>" +
              "Required URL format:<br/>" +
              "<code>?mobile=1&redirect_uri=astralalgomobile://auth&token=YOUR_WIX_TOKEN</code>";
            return;
          }

          // ‚úÖ Existing web behavior (UNCHANGED)
          const res = await fetch("/.netlify/functions/me", { credentials: "include" });
          if (!res.ok) throw new Error("Not logged in (no valid session cookie).");

          const data = await res.json();
          const u = data.user;

          document.getElementById("status").innerHTML =
            "<b>‚úÖ Logged in</b><br/>" +
            "Name: " + (u.name || "-") + "<br/>" +
            "Email: " + (u.email || "-") + "<br/>" +
            "Tier: <b>" + (u.tier || "member") + "</b>";
        } catch (e) {
          document.getElementById("status").innerHTML =
            "<b>‚ùå Not logged in</b><br/>" +
            (e.message || e);
        }
      })();
    </script>
  </body>
</html>
